@using Blazored.Modal.Services
@using ShowingAds.CoreLibrary.Models.Database
@using ShowingAds.WebAssembly.Client.Components.Modals
@using ShowingAds.WebAssembly.Client.Components.Forms 
@inject IModalService Modal
@implements IDisposable

<div class="card p-2 mb-0 mt-1">
    <div class="align-items-center pt-2 pr-2 pl-2">
        <button type="button" class="close float-right" @onclick="e => DeleteClientCallback.InvokeAsync(Client.Id)">
            <i class="fas fa-times"></i>
        </button>
        <button type="button" class="close mr-3 float-right" @onclick="() => OnSetInterval()">
            <i class="fas fa-sliders-h"></i>
        </button>
        <button style="background-color: rgb(@_red, @_green, @_blue)" class="card-text float-left btn" type="button" @onclick="e => OnAdvertisingVideoModal()">
            <h5 class="m-0">@_advertisingClient.Name</h5>
        </button>
    </div>
    @if (string.IsNullOrEmpty(_advertisingClient.Description) == false)
    {
        <p class="card-text ml-2 mb-0">Описание: @_advertisingClient.Description</p>
    }
    <p class="card-text ml-2 mb-0">Интервал показа: @Client.Interval.TotalMinutes мин</p>
    <p class="card-text ml-2 mb-0">Количество видеороликов: @_count</p>
    <p class="card-text ml-2 mb-0">Общая продолжительность: @_duration</p>
</div>

@code {
    [CascadingParameter]
    public AppContainer Container { get; set; }
    [Parameter]
    public ClientChannel Client { get; set; }
    [Parameter]
    public EventCallback<Guid> DeleteClientCallback { get; set; }

    private AdvertisingClient _advertisingClient { get; set; }

    private byte _red { get; set; } = 0;
    private byte _green { get; set; } = 0;
    private byte _blue { get; set; } = 0;

    private int _count { get; set; } = 0;
    private TimeSpan _duration { get; set; } = TimeSpan.Zero;

    protected async override Task OnInitializedAsync()
    {
        Container.ChannelUpdated += OnUpdate;
        OnUpdate();
        await base.OnInitializedAsync();
    }

    private async void OnUpdate()
    {
        bool isSuccess;
        (isSuccess, _advertisingClient) = await Container.AdvertisingClientManager.TryGetAsync(Client.AdvertisingClientId);
        if (isSuccess)
        {
            User user;
            (isSuccess, user) = await Container.UserManager.TryGetAsync(_advertisingClient.OwnerId);
            if (isSuccess)
            {
                _red = user.Red;
                _green = user.Green;
                _blue = user.Blue;
            }
        }
        var videos = await Container.AdvertisingVideoManager.GetCollectionAsync(x => Client.AdvertisingVideosId.Contains(x.Id));
        _duration = new TimeSpan(videos.Sum(video => video.Duration.Ticks));
        _count = videos.Count();
        await InvokeAsync(() => StateHasChanged());
    }

    public void Dispose()
    {
        Container.ChannelUpdated -= OnUpdate;
    }

    private void OnAdvertisingVideoModal()
    {
        var parameters = new ModalParameters();
        parameters.Add("Client", Client);
        parameters.Add("Container", Container);
        var options = new ModalOptions()
        {
            ContentScrollable = true,
            Animation = ModalAnimation.FadeIn(0.5),
            Class = "blazored-modal videos-size"
        };

        Modal.Show<ClientVideoModal>(_advertisingClient.Name, parameters, options);
    }

    private void OnSetInterval()
    {
        var parameters = new ModalParameters();
        parameters.Add("Client", Client);
        parameters.Add("Container", Container);
        var options = new ModalOptions()
        {
            Animation = ModalAnimation.FadeIn(0.5)
        };

        Modal.Show<ClientChannelForm>(_advertisingClient.Name, parameters, options);
    }
}
